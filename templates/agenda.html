{% extends "base.html" %}

{% block title %}Agenda - Gestao de Visitas{% endblock %}

{% block extra_css %}
<style>
/* Container principal */
.agenda-container {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    overflow: hidden;
}

.agenda-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    color: white;
    flex-wrap: wrap;
    gap: 1rem;
}

.nav-btns .btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 0.4rem 0.8rem;
}
.nav-btns .btn:hover { background: rgba(255,255,255,0.3); color: white; }

.view-toggle .btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; }
.view-toggle .btn.active { background: white; color: var(--primary-color); }

/* Grid Semanal */
.week-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e2e8f0;
}

.day-col {
    background: white;
    min-height: 350px;
}

.day-header {
    background: #f8fafc;
    padding: 0.75rem;
    text-align: center;
    border-bottom: 2px solid #e2e8f0;
}
.day-header .day-name { font-weight: 600; font-size: 0.8rem; color: #64748b; text-transform: uppercase; }
.day-header .day-num { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
.day-header.today { background: #dbeafe; border-bottom-color: var(--primary-color); }
.day-header.weekend { background: #fef2f2; }
.day-header.weekend .day-num { color: #dc2626; }

.day-body {
    padding: 0.5rem;
    min-height: 300px;
}

/* Grid Mensal */
.month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e2e8f0;
}

.month-header-row {
    display: contents;
}

.month-header-cell {
    background: #f1f5f9;
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
    color: #64748b;
    font-size: 0.85rem;
}

.month-day {
    background: white;
    min-height: 100px;
    padding: 0.5rem;
    cursor: pointer;
    transition: background 0.2s;
}
.month-day:hover { background: #f8fafc; }
.month-day.other-month { background: #f8fafc; opacity: 0.5; }
.month-day.today { background: #dbeafe; }
.month-day.weekend { background: #fef2f2; }

.month-day-num {
    font-weight: 600;
    font-size: 0.9rem;
    color: #374151;
    margin-bottom: 0.25rem;
}
.month-day.weekend .month-day-num { color: #dc2626; }

.month-events {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.month-event-dot {
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.7rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: white;
}

/* Cards de Eventos */
.event-card {
    border-radius: 0.4rem;
    padding: 0.5rem;
    margin-bottom: 0.4rem;
    border-left: 3px solid;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.85rem;
}
.event-card:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

/* Tipos de Eventos - Cores */
.tipo-visita { border-left-color: #f59e0b; background: #fffbeb; }
.tipo-reuniao { border-left-color: #3b82f6; background: #eff6ff; }
.tipo-feriado { border-left-color: #ef4444; background: #fef2f2; }
.tipo-apresentacao { border-left-color: #8b5cf6; background: #f5f3ff; }
.tipo-capacitacao { border-left-color: #10b981; background: #ecfdf5; }
.tipo-outro { border-left-color: #6b7280; background: #f9fafb; }

.dot-visita { background: #f59e0b; }
.dot-reuniao { background: #3b82f6; }
.dot-feriado { background: #ef4444; }
.dot-apresentacao { background: #8b5cf6; }
.dot-capacitacao { background: #10b981; }
.dot-outro { background: #6b7280; }

.event-card .event-title { font-weight: 600; color: #1e293b; }
.event-card .event-time { font-size: 0.75rem; color: #64748b; }
.event-card .event-local { font-size: 0.75rem; color: #64748b; }

.event-card.status-executado { opacity: 0.7; }
.event-card.status-executado .event-title { text-decoration: line-through; }
.event-card.status-cancelado { opacity: 0.5; }
.event-card.status-cancelado .event-title { text-decoration: line-through; color: #94a3b8; }

/* Botao adicionar */
.add-btn {
    width: 100%;
    border: 2px dashed #cbd5e1;
    background: transparent;
    color: #94a3b8;
    padding: 0.5rem;
    border-radius: 0.4rem;
    font-size: 0.8rem;
    transition: all 0.2s;
}
.add-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background: #f0f9ff; }

/* Stats e Legenda */
.stats-bar {
    display: flex;
    gap: 1.5rem;
    padding: 0.75rem 1.5rem;
    background: white;
    border-bottom: 1px solid #e2e8f0;
    flex-wrap: wrap;
}
.stat-item { display: flex; align-items: center; gap: 0.4rem; }
.stat-num { font-size: 1.25rem; font-weight: 700; }
.stat-label { font-size: 0.8rem; color: #64748b; }

.legend {
    display: flex;
    gap: 1rem;
    padding: 0.75rem 1.5rem;
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
    flex-wrap: wrap;
}
.legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; color: #64748b; }
.legend-dot { width: 10px; height: 10px; border-radius: 2px; }

/* Sugestao escola */
.sugestao-box {
    margin-top: 0.5rem;
    padding: 0.6rem;
    background: linear-gradient(135deg, #e0f2fe, #f0f9ff);
    border-radius: 0.4rem;
    border: 1px solid #7dd3fc;
    font-size: 0.85rem;
}
.sugestao-box .escola-nome { font-weight: 600; color: #0c4a6e; }
.sugestao-box .distancia { background: white; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem; }

/* Lista de escolas adicionadas */
#listaEscolas {
    max-height: 200px;
    overflow-y: auto;
}
#listaEscolas > div {
    font-size: 0.85rem;
}

/* Responsivo */
@media (max-width: 992px) {
    .week-grid, .month-grid { grid-template-columns: 1fr; }
    .day-col, .month-day { min-height: auto; }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabecalho -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div>
            <h1 class="page-title"><i class="bi bi-calendar-week"></i> Agenda</h1>
            <p class="text-muted mb-0">Planejamento de visitas, reunioes e eventos</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="irParaHoje()">
                <i class="bi bi-calendar-event"></i> Hoje
            </button>
            <button class="btn btn-primary btn-sm" onclick="abrirModalNovo()">
                <i class="bi bi-plus-circle"></i> Novo Evento
            </button>
        </div>
    </div>

    <!-- Container da Agenda -->
    <div class="agenda-container">
        <!-- Header com navegacao -->
        <div class="agenda-header">
            <div class="nav-btns d-flex gap-1">
                <button class="btn" onclick="navegarAnterior()"><i class="bi bi-chevron-left"></i></button>
                <button class="btn" onclick="navegarProximo()"><i class="bi bi-chevron-right"></i></button>
            </div>
            <h5 class="mb-0" id="periodoTitulo">--</h5>
            <div class="view-toggle btn-group btn-group-sm">
                <button class="btn active" id="btnSemana" onclick="setView('semana')">Semana</button>
                <button class="btn" id="btnMes" onclick="setView('mes')">Mes</button>
            </div>
        </div>

        <!-- Estatisticas -->
        <div class="stats-bar">
            <div class="stat-item"><span class="stat-num" id="statTotal">0</span><span class="stat-label">Total</span></div>
            <div class="stat-item"><span class="stat-num text-warning" id="statVisitas">0</span><span class="stat-label">Visitas</span></div>
            <div class="stat-item"><span class="stat-num text-primary" id="statReunioes">0</span><span class="stat-label">Reunioes</span></div>
            <div class="stat-item"><span class="stat-num text-danger" id="statFeriados">0</span><span class="stat-label">Feriados</span></div>
            <div class="stat-item"><span class="stat-num text-secondary" id="statOutros">0</span><span class="stat-label">Outros</span></div>
        </div>

        <!-- Grid do Calendario -->
        <div id="calendarContainer"></div>

        <!-- Legenda -->
        <div class="legend">
            <div class="legend-item"><div class="legend-dot dot-visita"></div>Visita</div>
            <div class="legend-item"><div class="legend-dot dot-reuniao"></div>Reuniao</div>
            <div class="legend-item"><div class="legend-dot dot-feriado"></div>Feriado</div>
            <div class="legend-item"><div class="legend-dot dot-apresentacao"></div>Apresentacao</div>
            <div class="legend-item"><div class="legend-dot dot-capacitacao"></div>Capacitacao</div>
            <div class="legend-item"><div class="legend-dot dot-outro"></div>Outro</div>
        </div>
    </div>
</div>

<!-- Modal: Novo/Editar Evento -->
<div class="modal fade" id="modalEvento" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEventoTitulo"><i class="bi bi-calendar-plus"></i> Novo Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEvento">
                    <input type="hidden" id="eventoId">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-tag"></i> Tipo</label>
                            <select class="form-select" id="eventoTipo" onchange="onTipoChange()">
                                <option value="visita">Visita a Escola</option>
                                <option value="reuniao">Reuniao</option>
                                <option value="apresentacao">Apresentacao</option>
                                <option value="capacitacao">Capacitacao</option>
                                <option value="feriado">Feriado</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-calendar"></i> Data</label>
                            <input type="date" class="form-control" id="eventoData" required>
                        </div>
                    </div>

                    <div class="mb-3" id="tituloGroup">
                        <label class="form-label"><i class="bi bi-fonts"></i> Titulo</label>
                        <input type="text" class="form-control" id="eventoTitulo" placeholder="Nome do evento">
                    </div>

                    <!-- Secao para tipos NAO escola (reuniao, feriado, etc) -->
                    <div id="eventoSimples">
                        <div class="mb-3" id="localGroup" style="display:none;">
                            <label class="form-label"><i class="bi bi-geo-alt"></i> Local</label>
                            <input type="text" class="form-control" id="eventoLocal" placeholder="Local do evento">
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6" id="horaGroup" style="display:none;">
                                <label class="form-label"><i class="bi bi-clock"></i> Horario</label>
                                <div class="d-flex gap-2">
                                    <input type="time" class="form-control" id="eventoHoraInicio" placeholder="Inicio">
                                    <input type="time" class="form-control" id="eventoHoraFim" placeholder="Fim">
                                </div>
                            </div>
                            <div class="col-md-6" id="mediadorGroupSimples" style="display:none;">
                                <label class="form-label"><i class="bi bi-person"></i> Responsavel</label>
                                <select class="form-select" id="eventoMediadorIdSimples">
                                    <option value="">Selecione (opcional)...</option>
                                    {% for mediador in mediadores %}
                                    <option value="{{ mediador.id }}" data-nome="{{ mediador.nome }}">{{ mediador.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-3" id="descricaoGroupSimples" style="display:none;">
                            <label class="form-label"><i class="bi bi-chat-text"></i> Descricao</label>
                            <textarea class="form-control" id="eventoDescricaoSimples" rows="2" placeholder="Observacoes..."></textarea>
                        </div>

                        <div class="form-check mb-3" id="diaInteiroGroup" style="display:none;">
                            <input class="form-check-input" type="checkbox" id="eventoDiaInteiro">
                            <label class="form-check-label" for="eventoDiaInteiro">Dia inteiro</label>
                        </div>
                    </div>

                    <!-- Secao para visitas/apresentacoes com multiplas escolas -->
                    <div id="escolasSection" style="display:none;">
                        <!-- Lista de escolas adicionadas -->
                        <div id="listaEscolasContainer" class="mb-3" style="display:none;">
                            <label class="form-label"><i class="bi bi-list-check"></i> Escolas a visitar</label>
                            <div id="listaEscolas"></div>
                        </div>

                        <!-- Formulario para adicionar escola -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title mb-3"><i class="bi bi-plus-circle"></i> Adicionar Escola</h6>

                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label small"><i class="bi bi-building"></i> Escola</label>
                                        <select class="form-select form-select-sm" id="eventoEscolaId">
                                            <option value="">Selecione...</option>
                                            {% for escola in escolas %}
                                            <option value="{{ escola.id }}" data-nome="{{ escola.nome_usual }}">{{ escola.nome_usual }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small"><i class="bi bi-sun"></i> Turno</label>
                                        <select class="form-select form-select-sm" id="eventoTurno">
                                            <option value="manha">Manha</option>
                                            <option value="tarde">Tarde</option>
                                            <option value="integral">Integral</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label small"><i class="bi bi-person"></i> Responsavel</label>
                                        <select class="form-select form-select-sm" id="eventoMediadorId">
                                            <option value="">Selecione (opcional)...</option>
                                            {% for mediador in mediadores %}
                                            <option value="{{ mediador.id }}" data-nome="{{ mediador.nome }}">{{ mediador.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small"><i class="bi bi-chat-text"></i> Observacoes</label>
                                        <input type="text" class="form-control form-control-sm" id="eventoDescricao" placeholder="Obs...">
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="adicionarEscolaLista()">
                                        <i class="bi bi-plus"></i> Adicionar
                                    </button>
                                </div>

                                <!-- Sugestao de escola proxima -->
                                <div id="sugestaoContainer"></div>
                            </div>
                        </div>
                    </div>
                </form>
                <div id="alertEvento"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarEvento()">
                    <i class="bi bi-check-circle"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Acoes do Evento -->
<div class="modal fade" id="modalAcoes" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="acaoTitulo">Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="acaoEventoId">
                <input type="hidden" id="acaoEventoTipo">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="editarEvento()"><i class="bi bi-pencil"></i> Editar</button>
                    <button class="btn btn-success" onclick="marcarExecutado()"><i class="bi bi-check-circle"></i> Marcar Executado</button>
                    <button class="btn btn-outline-warning" onclick="cancelarEvento()"><i class="bi bi-x-circle"></i> Cancelar</button>
                    <button class="btn btn-outline-info" onclick="duplicarEvento()"><i class="bi bi-copy"></i> Duplicar</button>
                    <hr>
                    <button class="btn btn-outline-danger" onclick="removerEvento()"><i class="bi bi-trash"></i> Remover</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Execucao de Visita -->
<div class="modal fade" id="modalExecucao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle-fill"></i> Registrar Execucao da Visita</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formExecucao">
                    <input type="hidden" id="execEventoId">

                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-building"></i> Escola</label>
                        <input type="text" class="form-control" id="execEscolaNome" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-calendar"></i> Data da Visita</label>
                        <input type="text" class="form-control" id="execData" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-paperclip"></i> Anexo(s) <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="execAnexos" multiple required accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        <div class="form-text">Formatos aceitos: PDF, JPG, PNG, DOC, DOCX. Pode selecionar multiplos arquivos.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-chat-text"></i> Observacoes</label>
                        <textarea class="form-control" id="execObservacoes" rows="2" placeholder="Observacoes sobre a visita..."></textarea>
                    </div>
                </form>
                <div id="alertExecucao"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmarExecucao()">
                    <i class="bi bi-check-circle"></i> Confirmar Execucao
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Estado
let viewMode = 'semana';
let currentDate = new Date();
let eventos = [];
let escolasParaAdicionar = []; // Lista de escolas a serem adicionadas como eventos
let modoEdicao = false; // Se esta editando um evento existente
const DIAS = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
const MESES = ['Janeiro', 'Fevereiro', 'Marco', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

// Inicializacao
document.addEventListener('DOMContentLoaded', () => {
    irParaHoje();
});

// Navegacao
function irParaHoje() { currentDate = new Date(); carregarDados(); }
function navegarAnterior() {
    if (viewMode === 'semana') currentDate.setDate(currentDate.getDate() - 7);
    else currentDate.setMonth(currentDate.getMonth() - 1);
    carregarDados();
}
function navegarProximo() {
    if (viewMode === 'semana') currentDate.setDate(currentDate.getDate() + 7);
    else currentDate.setMonth(currentDate.getMonth() + 1);
    carregarDados();
}

function setView(mode) {
    viewMode = mode;
    document.getElementById('btnSemana').classList.toggle('active', mode === 'semana');
    document.getElementById('btnMes').classList.toggle('active', mode === 'mes');
    carregarDados();
}

// Carregar Dados
async function carregarDados() {
    try {
        let url;
        if (viewMode === 'semana') {
            url = `/api/agenda/semana?data=${formatDate(currentDate)}`;
        } else {
            url = `/api/agenda/mes?ano=${currentDate.getFullYear()}&mes=${currentDate.getMonth() + 1}`;
        }
        const resp = await fetch(url);
        const data = await resp.json();

        eventos = [];
        if (data.eventos) {
            Object.values(data.eventos).forEach(arr => eventos.push(...arr));
        }

        atualizarTitulo(data);
        atualizarStats();
        renderizar(data);
    } catch (e) {
        console.error('Erro:', e);
    }
}

function atualizarTitulo(data) {
    if (viewMode === 'semana') {
        const inicio = new Date(data.semana_inicio + 'T12:00:00');
        const fim = new Date(data.semana_fim + 'T12:00:00');
        document.getElementById('periodoTitulo').textContent =
            `${inicio.getDate()}/${inicio.getMonth()+1} a ${fim.getDate()}/${fim.getMonth()+1}/${fim.getFullYear()}`;
    } else {
        document.getElementById('periodoTitulo').textContent = `${MESES[data.mes - 1]} ${data.ano}`;
    }
}

function atualizarStats() {
    document.getElementById('statTotal').textContent = eventos.length;
    document.getElementById('statVisitas').textContent = eventos.filter(e => e.tipo === 'visita').length;
    document.getElementById('statReunioes').textContent = eventos.filter(e => e.tipo === 'reuniao').length;
    document.getElementById('statFeriados').textContent = eventos.filter(e => e.tipo === 'feriado').length;
    document.getElementById('statOutros').textContent = eventos.filter(e => !['visita','reuniao','feriado'].includes(e.tipo)).length;
}

// Renderizacao
function renderizar(data) {
    const container = document.getElementById('calendarContainer');
    if (viewMode === 'semana') {
        container.innerHTML = renderSemana(data);
    } else {
        container.innerHTML = renderMes(data);
    }
}

function renderSemana(data) {
    const inicio = new Date(data.semana_inicio + 'T12:00:00');
    const hoje = new Date(); hoje.setHours(0,0,0,0);
    let html = '<div class="week-grid">';

    for (let i = 0; i < 7; i++) {
        const dia = new Date(inicio);
        dia.setDate(inicio.getDate() + i);
        const dataStr = formatDate(dia);
        const isToday = dia.toDateString() === hoje.toDateString();
        const isWeekend = dia.getDay() === 0 || dia.getDay() === 6;
        const eventosdia = (data.eventos[dataStr] || []);

        html += `
        <div class="day-col">
            <div class="day-header ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''}">
                <div class="day-name">${DIAS[dia.getDay()]}</div>
                <div class="day-num">${dia.getDate()}</div>
            </div>
            <div class="day-body" data-data="${dataStr}"
                 ondragover="event.preventDefault()" ondrop="onDrop(event, '${dataStr}')">
                ${eventosdia.map(e => renderEventCard(e)).join('')}
                <button class="add-btn" onclick="abrirModalNovo('${dataStr}')"><i class="bi bi-plus"></i></button>
            </div>
        </div>`;
    }
    html += '</div>';
    return html;
}

function renderMes(data) {
    let html = '<div class="month-grid">';
    html += '<div class="month-header-row">';
    DIAS.forEach(d => html += `<div class="month-header-cell">${d}</div>`);
    html += '</div>';

    const primeiroDia = new Date(data.ano, data.mes - 1, 1);
    const diasNoMes = data.total_dias;
    const inicioSemana = primeiroDia.getDay();
    const hoje = new Date(); hoje.setHours(0,0,0,0);

    const mesAnterior = new Date(data.ano, data.mes - 1, 0);
    for (let i = inicioSemana - 1; i >= 0; i--) {
        const d = mesAnterior.getDate() - i;
        html += `<div class="month-day other-month"><div class="month-day-num">${d}</div></div>`;
    }

    for (let d = 1; d <= diasNoMes; d++) {
        const dia = new Date(data.ano, data.mes - 1, d);
        const dataStr = formatDate(dia);
        const isToday = dia.toDateString() === hoje.toDateString();
        const isWeekend = dia.getDay() === 0 || dia.getDay() === 6;
        const eventosdia = data.eventos[dataStr] || [];

        html += `
        <div class="month-day ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''}" onclick="abrirModalNovo('${dataStr}')">
            <div class="month-day-num">${d}</div>
            <div class="month-events">
                ${eventosdia.slice(0, 3).map(e => `
                    <div class="month-event-dot dot-${e.tipo}" onclick="event.stopPropagation(); abrirModalAcoes('${e.id}')">${e.titulo || e.escola_nome || e.tipo}</div>
                `).join('')}
                ${eventosdia.length > 3 ? `<div class="text-muted" style="font-size:0.7rem">+${eventosdia.length - 3} mais</div>` : ''}
            </div>
        </div>`;
    }

    const totalCells = inicioSemana + diasNoMes;
    const remaining = (7 - (totalCells % 7)) % 7;
    for (let i = 1; i <= remaining; i++) {
        html += `<div class="month-day other-month"><div class="month-day-num">${i}</div></div>`;
    }

    html += '</div>';
    return html;
}

function renderEventCard(e) {
    const titulo = e.titulo || e.escola_nome || e.tipo;
    const horario = e.hora_inicio ? e.hora_inicio : (e.turno || '');
    return `
    <div class="event-card tipo-${e.tipo} status-${e.status}"
         draggable="true" data-id="${e.id}"
         ondragstart="onDragStart(event, '${e.id}')"
         onclick="abrirModalAcoes('${e.id}')">
        <div class="event-title">${titulo}</div>
        ${horario ? `<div class="event-time"><i class="bi bi-clock"></i> ${horario}</div>` : ''}
        ${e.local ? `<div class="event-local"><i class="bi bi-geo-alt"></i> ${e.local}</div>` : ''}
    </div>`;
}

// Drag & Drop
function onDragStart(event, id) {
    event.dataTransfer.setData('eventoId', id);
}

async function onDrop(event, novaData) {
    event.preventDefault();
    const id = event.dataTransfer.getData('eventoId');
    if (!id) return;
    try {
        await fetch(`/api/agenda/eventos/${id}/mover`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({data: novaData})
        });
        carregarDados();
    } catch (e) { console.error(e); }
}

// Modal Novo Evento
function abrirModalNovo(data) {
    modoEdicao = false;
    escolasParaAdicionar = [];
    document.getElementById('modalEventoTitulo').innerHTML = '<i class="bi bi-calendar-plus"></i> Novo Evento';
    document.getElementById('eventoId').value = '';
    document.getElementById('eventoData').value = data || formatDate(new Date());
    document.getElementById('eventoTipo').value = 'visita';
    document.getElementById('eventoTitulo').value = '';
    document.getElementById('eventoEscolaId').value = '';
    document.getElementById('eventoLocal').value = '';
    document.getElementById('eventoTurno').value = 'manha';
    document.getElementById('eventoHoraInicio').value = '';
    document.getElementById('eventoHoraFim').value = '';
    document.getElementById('eventoMediadorId').value = '';
    document.getElementById('eventoDescricao').value = '';
    document.getElementById('eventoDiaInteiro').checked = false;
    document.getElementById('sugestaoContainer').innerHTML = '';
    document.getElementById('alertEvento').innerHTML = '';
    atualizarListaEscolas();
    onTipoChange();
    new bootstrap.Modal(document.getElementById('modalEvento')).show();
}

function onTipoChange() {
    const tipo = document.getElementById('eventoTipo').value;
    const isVisita = tipo === 'visita' || tipo === 'apresentacao';
    const isFeriado = tipo === 'feriado';
    const isReuniao = tipo === 'reuniao' || tipo === 'capacitacao';

    // Secao de escolas (multiplas) - apenas para visita/apresentacao em modo novo
    document.getElementById('escolasSection').style.display = (isVisita && !modoEdicao) ? 'block' : 'none';

    // Secao simples (para outros tipos ou modo edicao)
    document.getElementById('eventoSimples').style.display = (!isVisita || modoEdicao) ? 'block' : 'none';
    document.getElementById('localGroup').style.display = isReuniao ? 'block' : 'none';
    document.getElementById('horaGroup').style.display = isReuniao ? 'block' : 'none';
    document.getElementById('mediadorGroupSimples').style.display = (!isFeriado && (!isVisita || modoEdicao)) ? 'block' : 'none';
    document.getElementById('descricaoGroupSimples').style.display = (!isVisita || modoEdicao) ? 'block' : 'none';
    document.getElementById('diaInteiroGroup').style.display = isFeriado ? 'block' : 'none';
    document.getElementById('tituloGroup').style.display = (!isVisita || modoEdicao) ? 'block' : 'none';
}

// Lista de escolas para adicionar
function atualizarListaEscolas() {
    const container = document.getElementById('listaEscolasContainer');
    const lista = document.getElementById('listaEscolas');

    if (escolasParaAdicionar.length === 0) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'block';
    lista.innerHTML = escolasParaAdicionar.map((e, idx) => `
        <div class="d-flex align-items-center justify-content-between p-2 mb-1 bg-white border rounded">
            <div>
                <strong>${e.escola_nome}</strong>
                <span class="badge bg-secondary ms-2">${e.turno}</span>
                ${e.mediador_nome ? `<small class="text-muted ms-2"><i class="bi bi-person"></i> ${e.mediador_nome}</small>` : ''}
                ${e.descricao ? `<small class="text-muted ms-2">(${e.descricao})</small>` : ''}
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerEscolaDaLista(${idx})">
                <i class="bi bi-x"></i>
            </button>
        </div>
    `).join('');
}

function adicionarEscolaLista() {
    const escolaSelect = document.getElementById('eventoEscolaId');
    const turnoSelect = document.getElementById('eventoTurno');
    const mediadorSelect = document.getElementById('eventoMediadorId');
    const descricaoInput = document.getElementById('eventoDescricao');

    if (!escolaSelect.value) {
        document.getElementById('alertEvento').innerHTML =
            '<div class="alert alert-warning py-2">Selecione uma escola</div>';
        return;
    }

    const escolaId = parseInt(escolaSelect.value);
    const escolaNome = escolaSelect.options[escolaSelect.selectedIndex].dataset.nome;

    // Verifica se a escola ja foi adicionada
    if (escolasParaAdicionar.some(e => e.escola_id === escolaId)) {
        document.getElementById('alertEvento').innerHTML =
            '<div class="alert alert-warning py-2">Esta escola ja foi adicionada</div>';
        return;
    }

    const mediadorId = mediadorSelect.value ? parseInt(mediadorSelect.value) : null;
    const mediadorNome = mediadorId ? mediadorSelect.options[mediadorSelect.selectedIndex].dataset.nome : '';

    escolasParaAdicionar.push({
        escola_id: escolaId,
        escola_nome: escolaNome,
        turno: turnoSelect.value,
        mediador_id: mediadorId,
        mediador_nome: mediadorNome,
        descricao: descricaoInput.value
    });

    // Limpa campos para proxima escola
    escolaSelect.value = '';
    turnoSelect.value = 'tarde'; // Proximo turno padrao
    descricaoInput.value = '';
    document.getElementById('alertEvento').innerHTML =
        `<div class="alert alert-success py-2"><i class="bi bi-check"></i> ${escolaNome} adicionada!</div>`;

    atualizarListaEscolas();

    // Busca sugestao de escola proxima apos adicionar
    buscarEscolaProxima(escolaId);
}

function removerEscolaDaLista(idx) {
    escolasParaAdicionar.splice(idx, 1);
    atualizarListaEscolas();
}

// Buscar escola proxima - com loading
async function buscarEscolaProxima(escolaIdParam = null) {
    const escolaSelect = document.getElementById('eventoEscolaId');
    const escolaId = escolaIdParam || escolaSelect.value;
    const container = document.getElementById('sugestaoContainer');

    if (!escolaId) { container.innerHTML = ''; return; }

    escolaSelect.disabled = true;
    container.innerHTML = `
        <div class="alert alert-secondary py-2 mt-2">
            <i class="bi bi-hourglass-split"></i> Sugerindo uma escola mais proxima, aguarde...
        </div>`;

    try {
        const resp = await fetch(`/api/escolas/${escolaId}/proximas?limite=1`);
        const proximas = await resp.json();
        if (proximas.length > 0) {
            const item = proximas[0];
            const escolaProxima = item.escola;
            container.innerHTML = `
            <div class="sugestao-box mt-2">
                <i class="bi bi-geo-alt-fill text-info"></i>
                <span class="escola-nome">${escolaProxima.nome_usual}</span>
                <span class="distancia">${item.distancia_km.toFixed(1)} km</span>
                <button type="button" class="btn btn-sm btn-outline-primary float-end"
                        onclick="adicionarEscolaSugerida(${escolaProxima.id}, '${escolaProxima.nome_usual}')">
                    <i class="bi bi-plus"></i> Adicionar
                </button>
            </div>`;
        } else {
            container.innerHTML = '';
        }
    } catch (e) {
        console.error(e);
        container.innerHTML = `<div class="alert alert-warning py-1 mt-2">Nao foi possivel sugerir escola proxima.</div>`;
    } finally {
        escolaSelect.disabled = false;
    }
}

function adicionarEscolaSugerida(escolaId, escolaNome) {
    // Verifica se ja foi adicionada
    if (escolasParaAdicionar.some(e => e.escola_id === escolaId)) {
        document.getElementById('sugestaoContainer').innerHTML =
            `<div class="alert alert-warning py-1 mt-2">${escolaNome} ja foi adicionada</div>`;
        return;
    }

    const mediadorSelect = document.getElementById('eventoMediadorId');
    const mediadorId = mediadorSelect.value ? parseInt(mediadorSelect.value) : null;
    const mediadorNome = mediadorId ? mediadorSelect.options[mediadorSelect.selectedIndex].dataset.nome : '';

    escolasParaAdicionar.push({
        escola_id: escolaId,
        escola_nome: escolaNome,
        turno: 'tarde', // Padrao para sugerida
        mediador_id: mediadorId,
        mediador_nome: mediadorNome,
        descricao: 'Escola proxima sugerida'
    });

    document.getElementById('sugestaoContainer').innerHTML =
        `<div class="alert alert-success py-1 mt-2"><i class="bi bi-check"></i> ${escolaNome} adicionada!</div>`;

    atualizarListaEscolas();
}

// Salvar Evento
async function salvarEvento() {
    const alertEl = document.getElementById('alertEvento');
    const tipo = document.getElementById('eventoTipo').value;
    const dataEvento = document.getElementById('eventoData').value;
    const isVisita = tipo === 'visita' || tipo === 'apresentacao';

    // Se for visita/apresentacao em modo novo, salva multiplas escolas
    if (isVisita && !modoEdicao) {
        if (escolasParaAdicionar.length === 0) {
            alertEl.innerHTML = '<div class="alert alert-danger py-2">Adicione pelo menos uma escola</div>';
            return;
        }

        alertEl.innerHTML = '<div class="alert alert-info py-2">Salvando eventos...</div>';

        try {
            for (const escola of escolasParaAdicionar) {
                const payload = {
                    tipo: tipo,
                    titulo: escola.escola_nome,
                    data: dataEvento,
                    turno: escola.turno,
                    escola_id: escola.escola_id,
                    escola_nome: escola.escola_nome,
                    descricao: escola.descricao,
                    mediador_id: escola.mediador_id,
                    mediador_nome: escola.mediador_nome,
                    dia_inteiro: false
                };

                const resp = await fetch('/api/agenda/eventos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.erro || 'Erro ao salvar');
                }
            }

            bootstrap.Modal.getInstance(document.getElementById('modalEvento')).hide();
            carregarDados();
        } catch (e) {
            alertEl.innerHTML = `<div class="alert alert-danger py-2">Erro: ${e.message}</div>`;
        }
        return;
    }

    // Modo edicao ou outros tipos de evento
    let titulo = document.getElementById('eventoTitulo').value;
    let escolaId = null, escolaNome = '';

    if (isVisita && modoEdicao) {
        const escolaSelect = document.getElementById('eventoEscolaId');
        if (!escolaSelect.value) {
            alertEl.innerHTML = '<div class="alert alert-danger py-2">Selecione uma escola</div>';
            return;
        }
        escolaId = parseInt(escolaSelect.value);
        escolaNome = escolaSelect.options[escolaSelect.selectedIndex].dataset.nome;
        titulo = titulo || escolaNome;
    }

    if (!titulo && !isVisita) {
        alertEl.innerHTML = '<div class="alert alert-danger py-2">Informe o titulo</div>';
        return;
    }

    const mediadorSelect = document.getElementById('eventoMediadorIdSimples');
    const mediadorId = mediadorSelect && mediadorSelect.value ? parseInt(mediadorSelect.value) : null;
    const mediadorNome = mediadorId ? mediadorSelect.options[mediadorSelect.selectedIndex].dataset.nome : '';

    const payload = {
        tipo: tipo,
        titulo: titulo,
        data: dataEvento,
        hora_inicio: document.getElementById('eventoHoraInicio').value || null,
        hora_fim: document.getElementById('eventoHoraFim').value || null,
        turno: document.getElementById('eventoTurno').value,
        escola_id: escolaId,
        escola_nome: escolaNome,
        local: document.getElementById('eventoLocal').value,
        descricao: document.getElementById('eventoDescricaoSimples')?.value || '',
        mediador_id: mediadorId,
        mediador_nome: mediadorNome,
        dia_inteiro: document.getElementById('eventoDiaInteiro').checked
    };

    alertEl.innerHTML = '<div class="alert alert-info py-2">Salvando...</div>';

    try {
        const eventoId = document.getElementById('eventoId').value;
        const url = eventoId ? `/api/agenda/eventos/${eventoId}` : '/api/agenda/eventos';
        const method = eventoId ? 'PUT' : 'POST';

        const resp = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (resp.ok) {
            bootstrap.Modal.getInstance(document.getElementById('modalEvento')).hide();
            carregarDados();
        } else {
            const err = await resp.json();
            alertEl.innerHTML = `<div class="alert alert-danger py-2">Erro: ${err.erro}</div>`;
        }
    } catch (e) {
        alertEl.innerHTML = `<div class="alert alert-danger py-2">Erro: ${e.message}</div>`;
    }
}

// Modal Acoes
function abrirModalAcoes(eventoId) {
    const evento = eventos.find(e => e.id === eventoId);
    if (!evento) return;

    document.getElementById('acaoEventoId').value = eventoId;
    document.getElementById('acaoEventoTipo').value = evento.tipo;
    document.getElementById('acaoTitulo').textContent = evento.titulo || evento.escola_nome || evento.tipo;
    new bootstrap.Modal(document.getElementById('modalAcoes')).show();
}

function editarEvento() {
    const id = document.getElementById('acaoEventoId').value;
    const e = eventos.find(ev => ev.id === id);
    if (!e) return;

    modoEdicao = true;
    escolasParaAdicionar = [];

    bootstrap.Modal.getInstance(document.getElementById('modalAcoes')).hide();

    document.getElementById('modalEventoTitulo').innerHTML = '<i class="bi bi-pencil"></i> Editar Evento';
    document.getElementById('eventoId').value = e.id;
    document.getElementById('eventoTipo').value = e.tipo;
    document.getElementById('eventoData').value = e.data;
    document.getElementById('eventoTitulo').value = e.titulo || '';
    document.getElementById('eventoEscolaId').value = e.escola_id || '';
    document.getElementById('eventoLocal').value = e.local || '';
    document.getElementById('eventoTurno').value = e.turno || 'manha';
    document.getElementById('eventoHoraInicio').value = e.hora_inicio || '';
    document.getElementById('eventoHoraFim').value = e.hora_fim || '';

    if (document.getElementById('eventoMediadorIdSimples')) {
        document.getElementById('eventoMediadorIdSimples').value = e.mediador_id || '';
    }
    if (document.getElementById('eventoDescricaoSimples')) {
        document.getElementById('eventoDescricaoSimples').value = e.descricao || '';
    }

    document.getElementById('eventoDiaInteiro').checked = e.dia_inteiro || false;
    document.getElementById('sugestaoContainer').innerHTML = '';
    document.getElementById('alertEvento').innerHTML = '';
    onTipoChange();

    new bootstrap.Modal(document.getElementById('modalEvento')).show();
}

async function marcarExecutado() {
    const id = document.getElementById('acaoEventoId').value;
    const tipo = document.getElementById('acaoEventoTipo').value;
    const evento = eventos.find(e => e.id === id);

    // Se for visita a escola, abre modal para anexar comprovante
    if (tipo === 'visita' && evento) {
        bootstrap.Modal.getInstance(document.getElementById('modalAcoes')).hide();

        document.getElementById('execEventoId').value = id;
        document.getElementById('execEscolaNome').value = evento.escola_nome || evento.titulo || '';
        document.getElementById('execData').value = evento.data;
        document.getElementById('execAnexos').value = '';
        document.getElementById('execObservacoes').value = '';
        document.getElementById('alertExecucao').innerHTML = '';

        new bootstrap.Modal(document.getElementById('modalExecucao')).show();
        return;
    }

    // Para outros tipos de evento, executa diretamente
    await fetch(`/api/agenda/eventos/${id}/executar`, {method: 'POST'});
    bootstrap.Modal.getInstance(document.getElementById('modalAcoes')).hide();
    carregarDados();
}

async function cancelarEvento() {
    if (!confirm('Cancelar este evento?')) return;
    const id = document.getElementById('acaoEventoId').value;
    await fetch(`/api/agenda/eventos/${id}/cancelar`, {method: 'POST'});
    bootstrap.Modal.getInstance(document.getElementById('modalAcoes')).hide();
    carregarDados();
}

async function duplicarEvento() {
    const id = document.getElementById('acaoEventoId').value;
    const novaData = prompt('Data para duplicar (YYYY-MM-DD):', formatDate(new Date()));
    if (!novaData) return;
    await fetch(`/api/agenda/eventos/${id}/duplicar`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({data: novaData})
    });
    bootstrap.Modal.getInstance(document.getElementById('modalAcoes')).hide();
    carregarDados();
}

async function removerEvento() {
    if (!confirm('Remover este evento permanentemente?')) return;
    const id = document.getElementById('acaoEventoId').value;
    await fetch(`/api/agenda/eventos/${id}`, {method: 'DELETE'});
    bootstrap.Modal.getInstance(document.getElementById('modalAcoes')).hide();
    carregarDados();
}

// Confirmar execucao de visita com anexo
async function confirmarExecucao() {
    const alertEl = document.getElementById('alertExecucao');
    const eventoId = document.getElementById('execEventoId').value;
    const anexosInput = document.getElementById('execAnexos');
    const observacoes = document.getElementById('execObservacoes').value;

    // Valida anexo obrigatorio
    if (!anexosInput.files || anexosInput.files.length === 0) {
        alertEl.innerHTML = '<div class="alert alert-danger py-2">Anexo e obrigatorio para registrar a execucao da visita.</div>';
        return;
    }

    alertEl.innerHTML = '<div class="alert alert-info py-2"><i class="bi bi-hourglass-split"></i> Salvando...</div>';

    try {
        const formData = new FormData();
        formData.append('evento_id', eventoId);
        formData.append('observacoes', observacoes);

        for (let i = 0; i < anexosInput.files.length; i++) {
            formData.append('anexos', anexosInput.files[i]);
        }

        const resp = await fetch('/api/agenda/eventos/executar-visita', {
            method: 'POST',
            body: formData
        });

        if (resp.ok) {
            bootstrap.Modal.getInstance(document.getElementById('modalExecucao')).hide();
            carregarDados();
        } else {
            const err = await resp.json();
            alertEl.innerHTML = `<div class="alert alert-danger py-2">Erro: ${err.erro || 'Erro ao salvar'}</div>`;
        }
    } catch (e) {
        alertEl.innerHTML = `<div class="alert alert-danger py-2">Erro: ${e.message}</div>`;
    }
}

// Utils
function formatDate(d) { return d.toISOString().split('T')[0]; }
</script>
{% endblock %}
